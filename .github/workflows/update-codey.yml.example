# .github/workflows/update-codey.yml
name: 🐾 Update Codey Tamagotchi

on:
  schedule:
    # Täglich um 6:00 UTC (8:00 MESZ)
    - cron: '0 6 * * *'
  workflow_dispatch: # Manuelle Ausführung möglich
  push:
    branches: [ main ]
    paths: 
      - '.github/workflows/update-codey.yml'
      - 'scripts/**'

jobs:
  update-codey:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
    - name: 🚀 Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dateutil

    - name: 📊 Fetch GitHub Stats
      id: github-stats
      run: |
        python scripts/fetch_github_stats.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}

    - name: 🎨 Generate Codey SVG
      id: generate-svg
      run: |
        python scripts/generate_codey.py
      env:
        GITHUB_STATS: ${{ steps.github-stats.outputs.stats }}

    - name: 📝 Update README
      run: |
        python scripts/update_readme.py

    - name: 💾 Commit Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Codey Bot 🤖"
        
        if [[ `git status --porcelain` ]]; then
          git add codey.svg README.md codey-data.json
          git commit -m "🐾 Daily Codey update - $(date +'%Y-%m-%d %H:%M')"
          git push
        else
          echo "No changes to commit"
        fi

    - name: 📈 Update Stats Badge
      uses: schneegans/dynamic-badges-action@v1.6.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ${{ secrets.GIST_ID }}
        filename: codey-stats.json
        label: Codey Health
        message: ${{ steps.generate-svg.outputs.health }}%
        color: ${{ steps.generate-svg.outputs.health_color }}
